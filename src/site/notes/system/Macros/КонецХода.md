---
{"dg-publish":true,"permalink":"/system/macros/konecz-hoda/"}
---

<%*
const file = tp.file.find_tfile(tp.file.title);
const oldContent = await app.vault.read(file);

// 1. Сохраняем старый контент
const oldContentCopy = oldContent.trim();

// 2. Разбиваем на блоки персонажей
const contentBeforeEnd = oldContent.split('---')[0];
const blocks = contentBeforeEnd.split(/(?=<\[\[)/g)
  .map(b => b.trim())
  .filter(b => b.startsWith('<[['));
  
// 3. Считываем ход и увеличиваем на 1
let moveMatch = oldContent.match(/\[\[Ход\]\]:\s*(\d+)/);
let moveValue = moveMatch ? Number(moveMatch[1]) + 1 : 1;

// 4-8. Парсим данные по каждому персонажу и обрабатываем по правилам
let result = [];
blocks.forEach(block => {
  const nameMatch = block.match(/^<\[\[([^\]]+)\]\]>/);
  if (!nameMatch) return;
  const name = nameMatch[1];
  const characteristics = {};
  const statusesWithPart = [];

  // Основные характеристики и статусы без части тела
  const regexSimple = /\[\[([^\]]+)\]\]:\s*(-?\d+)/g;
  let match;
  while ((match = regexSimple.exec(block)) !== null) {
    let key = match[1];
    let value = Number(match[2]);
    characteristics[key] = value;
  }

  // Статусы с частью тела (например: [[Механика/Термины/Негативные эффекты/Увечье\|Увечье]]: Рука - 3)
  const regexStatusPart = /\[\[(Увечье|Иней|Перегрев)\]\]:\s*([^\-\n]+)-\s*(\d+)/g;
  let m2;
  while ((m2 = regexStatusPart.exec(block)) !== null) {
    statusesWithPart.push({ type: m2[1], part: m2[2].trim(), duration: Number(m2[3]) });
  }

  result.push({ name, characteristics, statusesWithPart });
});

// Обработка каждого персонажа по правилам:
result.forEach(character => {
  let c = character.characteristics;

  // [[Механика/Персонаж и его анкета/Характеристики/Подробнее/Барьер\|Барьер]] уменьшается на [[Механика/Причуды/Механики/Огонь и лёд/Стужа\|Стужа]] и [[Механика/Причуды/Механики/Огонь и лёд/Ожог\|Ожог]]
  let stuzha = c["Стужа"] ?? 0;
  let ozhog = c["Ожог"] ?? 0;

  if (typeof c["Барьер"] === "number") {
    c["Барьер"] -= (stuzha + ozhog);
    if (c["Барьер"] < 0) {
      c["Здоровье"] += c["Барьер"];
      c["Барьер"] = 0;
    }
    if (c["Здоровье"] < 0) c["Здоровье"] = 0;
    if (isNaN(c["Барьер"])) c["Барьер"] = 0;
    if (isNaN(c["Здоровье"])) c["Здоровье"] = 0;
  }

  // [[Механика/Персонаж и его анкета/Характеристики/Подробнее/Щит\|Щит]] уменьшается на [[Механика/Термины/Негативные эффекты/Отрава\|Отрава]]
  let yad = c["Отрава"] ?? 0;

  if (typeof c["Щит"] === "number") {
    c["Щит"] -= yad;
    if (c["Щит"] < 0) {
      c["Здоровье"] += c["Щит"];
      c["Щит"] = 0;
    }
    if (c["Здоровье"] < 0) c["Здоровье"] = 0;
    if (isNaN(c["Щит"])) c["Щит"] = 0;
    if (isNaN(c["Здоровье"])) c["Здоровье"] = 0;
}

   // [[Механика/Причуды/Механики/Огонь и лёд/Стужа\|Стужа]], [[Механика/Термины/Негативные эффекты/Отрава\|Отрава]], [[Механика/Причуды/Механики/Огонь и лёд/Ожог\|Ожог]] уменьшаются на единицу, но не уходят ниже нуля
   ["Стужа","Отрава","Ожог"].forEach(stat => {
     if(typeof c[stat]==="number") {
       c[stat]=Math.max(0,c[stat]-1);
     }
   });
   //Если ноги поломаны
character.statusesWithPart.forEach(s => {
  if (s.type === 'Увечье' && s.part.toLowerCase() === 'ноги') {
  c["Скорость"] = 4 - s.duration;
   if (c["Скорость"] < 0) { c["Скорость"] == 0;}
  }
  else{c["Скорость"] == 4}
});
   // Увечья, Иней, Перегрев — только если значение больше нуля и уменьшаются на единицу
   character.statusesWithPart.forEach(s=>{
     s.duration=Math.max(0,s.duration-1);
   });
});


// Формируем вывод

let output=`[[Ход]]: ${moveValue}\n\n`;

for(let character of result){
let chars=character.characteristics;

// Имя блока
output+=`<[[${character.name}]]>:\n`;

// Основные характеристики
output+=`[[Здоровье]]: ${chars['Здоровье']??0}, [[Барьер]]: ${chars['Барьер']??0}, [[Щит]]: ${chars['Щит']??0}, [[Скорость]]: ${chars['Скорость']??0}\n`;

// Статусы с частью тела — только если >0
let statusParts=[];
for(let statName of ["Увечье","Иней","Перегрев"]) {
 character.statusesWithPart.filter(s=>s.type===statName&&s.duration>0)
 .forEach(s=>statusParts.push(`[[${statName}]]: ${s.part} - ${s.duration}`));
}
if(statusParts.length>0) output+=statusParts.join(", ")+"\n";

// Остальные статусы — только если >0
let statusSimple=[];
for(let stat of ["Закат","Рассвет","Поток","Отрава","Ожог","Стужа"]) {
 if(typeof chars[stat]==="number"&&chars[stat]>0)
   statusSimple.push(`[[${stat}]]: ${chars[stat]}`);
}
if(statusSimple.length>0) output+=statusSimple.join(", ")+"\n";

output+="\n";
}

// Вставляем --- и старый контент в конце:
output+="---\n"+oldContentCopy;

await app.vault.modify(file, '');
tR+=output;
tp.file.cursor(0);
%>
