---
{"dg-publish":true,"permalink":"/system/macros/konecz-hoda-2/"}
---

<%*
const file = tp.file.find_tfile(tp.file.title);
const oldContent = await app.vault.read(file);

// Парсим старые значения из текста (ищем строки вида "Здоровье: число")
function getValue(name) {
  const match = oldContent.match(new RegExp(name + "]]:\\s*(\\d+)", "i"));
  return match ? Number(match[1]) : 0;
}
// Парсим старые значения из текста (ищем строки вида "Здоровье: текст")
function getTextValue(name) {
  const match = oldContent.match(new RegExp(name + "]]:\\s*([\\wа-яА-ЯёЁ]+)", "i"));
  return match ? match[1] : "";
}

//Броски
let голова = 0;
let руки = 0;
let тело = 0;
let ноги = 0;
//Характеристики
let здоровье = getValue("Здоровье");
let щит = getValue("Щит");
let барьер = getValue("Барьер");
let скорость = getValue("Скорость");
//DoT-ы
let яд = getValue("Яд");
let ожог = getValue("Ожог");
let стужа = getValue("Стужа");
//статусы
let перегрев = getValue("Перегрев");
let иней = getValue("Иней");
let увечье = getValue("Увечье");
//части тела
let жар = getTextValue("Жар");
let холод = getTextValue("Холод");
let травма = getTextValue("Травма");
//таймеры и пр.
let ход = getValue("Ход");
let закат = getValue("Закат");
let рассвет = getValue("Рассвет");
let поток = getValue("Поток");


// Вычисления
if (яд > 0) {
    if (щит > 0) 
		{щит -= яд;
	    if (щит < 0) 
			{здоровье += щит;
	        щит = 0;}
	    } 
	else {здоровье -= яд;}
яд -= 1;}

if (стужа > 0) 
	{if (барьер > 0) 
		{барьер -= стужа;
	    if (барьер < 0) 
			{здоровье += барьер;
	        барьер = 0;}
	    }
	else {здоровье -= стужа;}    
стужа -= 1;}

if (ожог > 0)
{if (барьер > 0) 
	{барьер -= ожог;
     if (барьер < 0) 
		 {здоровье += барьер;
	     барьер = 0;}
    } 
	else {здоровье -= ожог;}    
ожог -= 1;}

if (иней > 0) 
{if (холод == "голова")
	{голова -= 1;}
	if (холод == "тело") 
	{тело -= 1;}
	if (холод == "ноги") 
	{ноги -= 1;}
	if (холод == "руки")
	{руки -= 1;}
иней -= 1;}
else {холод = "норма";}

if (увечье > 0) 
{if (травма == "голова") 
	{голова -= 1;}
	if (травма == "тело") 
	{тело -= 1;}
	if (травма == "ноги")
	{скорость -= увечье;
	if (скорость < 0){ скорость = 0;}
	}
	if (травма == "руки") 
	{руки -= 1;}
увечье -=1;}
else {скорость = 4;}

if (перегрев > 0) 
{перегрев -=1;}
else 
{жар = "норма";}

ход += 1;

// Очищаем файл
await app.vault.modify(file, "");
// Формируем новый блок характеристик + старое содержимое файла
tR =`### [[Ход\|Ход]]: ${ход}
[[Голова\|Голова]]: ${голова} 
[[Руки\|Руки]]: ${руки} 
[[Тело\|Тело]]: ${тело} 
[[Ноги\|Ноги]]: ${ноги} 

| [[Механика/Персонаж и его анкета/Характеристики/Подробнее/Здоровье\|Здоровье]]: ${здоровье} | [[Механика/Персонаж и его анкета/Характеристики/Подробнее/Щит\|Щит]]: ${щит}       | [[Механика/Персонаж и его анкета/Характеристики/Подробнее/Барьер\|Барьер]]: ${барьер} | [[Механика/Персонаж и его анкета/Характеристики/Подробнее/Скорость\|Скорость]]: ${скорость} |
| ------------------------- | --------------------- | --------------------- | ------------------------- |
| [[Жар\|Жар]]: ${жар}           | [[Травма\|Травма]]: ${травма} | [[Холод\|Холод]]: ${холод}   | [[Механика/Причуды/Механики/Поток\|Поток]]: ${поток}       |
| [[Механика/Причуды/Механики/Огонь и лёд/Перегрев\|Перегрев]]: ${перегрев} | [[Механика/Термины/Негативные эффекты/Увечье\|Увечье]]: ${увечье} | [[Механика/Причуды/Механики/Огонь и лёд/Иней\|Иней]]: ${иней}     | [[Механика/Причуды/Механики/Закат и Рассвет/Закат\|Закат]]: ${закат}       |
| [[Механика/Причуды/Механики/Огонь и лёд/Ожог\|Ожог]]: ${ожог}         | [[Механика/Термины/Негативные эффекты/Отрава\|Отрава]]: ${яд}         | [[Механика/Причуды/Механики/Огонь и лёд/Стужа\|Стужа]]: ${стужа}   | [[Механика/Причуды/Механики/Закат и Рассвет/Рассвет\|Рассвет]]: ${рассвет}   |

--- 
${oldContent}`;
%>
